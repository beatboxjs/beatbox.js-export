!function(){function e(e){return n(0,e.length,1)}function n(e,n,t){for(var r=[],o=e;n>o;o+=t)r.push(o);return r}function t(e){var n=document.createElement("div");return n.innerHTML='<a href="'+e.split("&").join("&amp;").split("<").join("&lt;").split('"').join("&quot;")+'">x</a>',n.firstChild.href}function r(e){for(var n=new ArrayBuffer(e.length),t=new Uint8Array(n),r=0,o=e.length;o>r;r++)t[r]=e.charCodeAt(r);return n}var o=Beatbox.Export={_getWaveForInstrument:function(e,n){return"undefined"!=typeof e.bbWave?n(e.bbWave):void async.waterfall([function(n){if("undefined"!=typeof e.soundObj.bbWave)return n(null,e.soundObj.bbWave);var a=e.soundObj._urls[0],u=null;if(a.match(/^data:/)){var i=a.match(/base64,(.*)$/);u=AV.Asset.fromBuffer(r(atob(i[1])))}else u=AV.Asset.fromURL(t(a));o._decodeToBuffer(u,function(t,r){t&&console.error("Error decoding "+e.soundObj._urls[0]+":",t),e.soundObj.bbWave=r||null,n(null,r)})},function(t,r){e.bbWave=t,n(e.bbWave)}])},_decodeToBuffer:function(e,n){e.decodeToBuffer(function(e){n(null,e)}),e.on("error",function(e){n(e)})},_encodeWAV:function(e,n,t){WavEncoder.encode({sampleRate:44100,channelData:[e,n]}).then(function(e){t(new Blob([e],{type:"audio/wav"}))})},_encodeMP3:function(e,t,r){var o=Lame.init();Lame.set_mode(o,Lame.JOINT_STEREO),Lame.set_num_channels(o,2),Lame.set_in_samplerate(o,44100),Lame.set_out_samplerate(o,44100),Lame.set_bitrate(o,128),Lame.init_params(o);var a=[],u=2e4;async.each(n(0,e.length,u),function(n,r){a.push(Lame.encode_buffer_ieee_float(o,e.subarray(n,n+u),t.subarray(n,n+u)).data),setTimeout(r,0)},function(){a.push(Lame.encode_flush(o).data),Lame.close(o),r(new Blob(a,{type:"audio/mp3"}))})},_getBufferForPattern:function(n,t,r){var a=new Array(Math.ceil(n.length*t*44.1)),u=new Array(Math.ceil(n.length*t*44.1));async.eachSeries(e(n),function(r,i){async.eachSeries(e(n[r]),function(e,i){var f=Beatbox._getInstrumentWithParams(n[r][e]);return f?void o._getWaveForInstrument(f.instrumentObj,function(e){if(e)for(var n=Math.floor(r*t*44.1),o=0;o<e.length;n++,o+=1)a[n]||(a[n]=0),a[n]+=e[o],u[n]||(u[n]=0),u[n]+=e[o];setTimeout(i,0)}):setTimeout(i,0)},i)},function(){r(new Float32Array(a),new Float32Array(u))})}};Beatbox.prototype.exportMP3=function(e){o._getBufferForPattern(this._pattern,this._strokeLength,function(n,t){o._encodeMP3(n,t,e)})},Beatbox.prototype.exportWAV=function(e){o._getBufferForPattern(this._pattern,this._strokeLength,function(n,t){o._encodeWAV(n,t,e)})}}();