!function(){function e(e){for(var n=[],t=0;t<e.length;t++)n.push(t);return n}function n(e){var n=document.createElement("div");return n.innerHTML='<a href="'+e.split("&").join("&amp;").split("<").join("&lt;").split('"').join("&quot;")+'">x</a>',n.firstChild.href}var t=Beatbox.Export={_getWaveForInstrument:function(e,o){return"undefined"!=typeof e.bbWave?o(e.bbWave):void async.waterfall([function(o){return"undefined"!=typeof e.soundObj.bbWave?o(null,e.soundObj.bbWave):void t._decodeToBuffer(AV.Asset.fromURL(n(e.soundObj._urls[0])),function(n,t){n&&console.error("Error decoding "+e.soundObj._urls[0]+":",n),e.soundObj.bbWave=t||null,o(null,t)})},function(n,t){e.bbWave=n,o(e.bbWave)}])},_decodeToBuffer:function(e,n){e.decodeToBuffer(function(e){n(null,e)}),e.on("error",function(e){n(e)})},_encodeWAV:function(e,n,t){WavEncoder.encode({sampleRate:44100,channelData:[e,n]}).then(function(e){t(new Blob([e],{type:"audio/wav"}))})},_encodeMP3:function(e,n,t){var o=Lame.init();Lame.set_mode(o,Lame.JOINT_STEREO),Lame.set_num_channels(o,2),Lame.set_in_samplerate(o,44100),Lame.set_out_samplerate(o,44100),Lame.set_bitrate(o,128),Lame.init_params(o);for(var r=[],a=2e4,u=0;u<e.length;u+=a)r.push(Lame.encode_buffer_ieee_float(o,e.subarray(u,u+a),n.subarray(u,u+a)).data);r.push(Lame.encode_flush(o).data),Lame.close(o),t(new Blob(r,{type:"audio/mp3"}))},_getBufferForPattern:function(n,o,r){var a=new Array(Math.ceil(n.length*o*44.1)),u=new Array(Math.ceil(n.length*o*44.1));async.eachSeries(e(n),function(r,i){async.eachSeries(e(n[r]),function(e,i){var f=Beatbox._getInstrumentWithParams(n[r][e]);return f?void t._getWaveForInstrument(f.instrumentObj,function(e){if(e)for(var n=Math.floor(r*o*44.1),t=0;t<e.length;n++,t+=1)a[n]||(a[n]=0),a[n]+=e[t],u[n]||(u[n]=0),u[n]+=e[t];i()}):i()},i)},function(){r(new Float32Array(a),new Float32Array(u))})}};Beatbox.prototype.exportMP3=function(e){t._getBufferForPattern(this._pattern,this._strokeLength,function(n,o){t._encodeMP3(n,o,e)})},Beatbox.prototype.exportWAV=function(e){t._getBufferForPattern(this._pattern,this._strokeLength,function(n,o){t._encodeWAV(n,o,e)})}}();