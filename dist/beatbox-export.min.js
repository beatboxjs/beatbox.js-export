!function(){function e(e){return t(0,e.length,1)}function t(e,t,n){for(var a=[],r=e;t>r;r+=n)a.push(r);return a}function n(e){var t=document.createElement("div");return t.innerHTML='<a href="'+e.split("&").join("&amp;").split("<").join("&lt;").split('"').join("&quot;")+'">x</a>',t.firstChild.href}function a(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),a=0,r=e.length;r>a;a++)n[a]=e.charCodeAt(a);return t}function r(e,t,n){if(e.slice)return e.slice(t,n);for(var a=new e.constructor(n-t),r=t,o=0;n>r;r++,o++)a[o]=e[r];return a}var o=Beatbox.Export={_outputSampleRate:44100,_getWaveForInstrument:function(e,t){return e.bbChannelData?t(e.bbChannelData):void async.waterfall([function(t){if("undefined"!=typeof e.soundObj.bbChannelData)return t(null,e.soundObj.bbChannelData);var r=e.soundObj._urls[0],u=null;if(r.match(/^data:/)){var l=r.match(/base64,(.*)$/);u=AV.Asset.fromBuffer(a(atob(l[1])))}else u=AV.Asset.fromURL(n(r));o._decodeToBuffer(u,function(n,a){n&&console.error("Error decoding "+e.soundObj._urls[0]+":",n),e.soundObj.bbChannelData=a||null,t(null,a)})},function(n,a){if(e.sprite){e.bbChannelData=[];for(var u=e.soundObj._sprite[e.sprite]||[0,0],l=0;l<n.length;l++)e.bbChannelData.push(r(n[l],u[0]*o._outputSampleRate/1e3,(u[0]+u[1])*o._outputSampleRate/1e3))}else e.bbChannelData=n;t(e.bbChannelData)}])},_decodeToBuffer:function(e,t){e.decodeToBuffer(function(n){e.get("format",function(e){for(var a=Math.ceil(n.length/e.channelsPerFrame),r=new Float32Array(a),u=new Float32Array(a),l=0;a>l;l++)r[l]=n[l*e.channelsPerFrame],u[l]=n[l*e.channelsPerFrame+(e.channelsPerFrame>1?1:0)];e.sampleRate!=o._outputSampleRate&&(r=audioLib.Sink.resample(r,e.sampleRate,o._outputSampleRate),u=audioLib.Sink.resample(u,e.sampleRate,o._outputSampleRate)),t(null,[r,u])})}),e.on("error",t)},_encodeWAV:function(e,t,n){WavEncoder.encode({sampleRate:o._outputSampleRate,channelData:[e,t]}).then(function(e){n(new Blob([e],{type:"audio/wav"}))})},_encodeMP3:function(e,n,a,r){var u=Lame.init();Lame.set_mode(u,Lame.JOINT_STEREO),Lame.set_num_channels(u,2),Lame.set_in_samplerate(u,o._outputSampleRate),Lame.set_out_samplerate(u,o._outputSampleRate),Lame.set_bitrate(u,128),Lame.init_params(u);var l=[],i=5e3;async.eachSeries(t(0,e.length,i),function(t,a){l.push(Lame.encode_buffer_ieee_float(u,e.subarray(t,t+i),n.subarray(t,t+i)).data),r&&r(t/e.length),async.nextTick(a)},function(){l.push(Lame.encode_flush(u).data),Lame.close(u),a(new Blob(l,{type:"audio/mp3"}))})},_getBufferForPattern:function(t,n,a,u){var l=new Float32Array(Math.ceil((3e3+t.length*n)*o._outputSampleRate/1e3)),i=new Float32Array(Math.ceil((3e3+t.length*n)*o._outputSampleRate/1e3)),c=0,s=0;async.eachSeries(e(t),function(a,r){async.eachSeries(e(t[a]),function(e,r){var u=Beatbox._getInstrumentWithParams(t[a][e]);return u?void o._getWaveForInstrument(u.instrumentObj,function(e){if(e){var t,s;for(t=Math.floor(a*n*o._outputSampleRate/1e3),s=0;s<e[0].length;t++,s++)l[t]+=e[0][s]*u.volume,i[t]+=e[1][s]*u.volume;c=Math.max(c,t)}async.nextTick(r)}):async.nextTick(r)},function(){var e=a/t.length;e-s>.003&&(u&&u(e),s=e),async.nextTick(r)})},function(){for(var e=0;e<l.length;e++)l[e]=Math.tanh(l[e]),i[e]=Math.tanh(i[e]);a(r(l,0,c),r(i,0,c))})}};Beatbox.prototype.exportMP3=function(e,t){o._getBufferForPattern(this._pattern,this._strokeLength,function(n,a){o._encodeMP3(n,a,e,function(e){t&&t(.25+.75*e)})},function(e){t&&t(.25*e)})},Beatbox.prototype.exportWAV=function(e,t){o._getBufferForPattern(this._pattern,this._strokeLength,function(t,n){o._encodeWAV(t,n,e)},t)}}();